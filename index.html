<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <title>Конфигурация сети</title>
    <link rel="stylesheet" href="style.css" />
  </head>
  <body>
    <div class="container">
      <h1>Настройка сетевого сканера</h1>

      <label for="subnet">Диапазон известных IP:</label>
      <input type="text" id="subnet" placeholder="например: 192.168.0.0/24" />
      <p class="hint">
        Если вы не введёте диапазон, он будет определен автоматически.
      </p>

      <label for="macs">MAC-адреса известных устройств (через запятую):</label>
      <input type="text" id="macs" placeholder="AA:BB:CC:DD:EE:FF, ..." />

      <label for="ips">IP-адреса известных устройств (через запятую):</label>
      <input type="text" id="ips" placeholder="192.168.0.101, ..." />

      <button onclick="submitData()">Сохранить настройки</button>
      <button id="scanBtn" onclick="toggleScan()" disabled>
        Запустить сканирование
      </button>
      <p id="response"></p>
    </div>

    <script>
      let scanning = false;

      function isValidMAC(mac) {
        return /^([0-9A-Fa-f]{2}:){5}[0-9A-Fa-f]{2}$/.test(mac);
      }

      function isValidIP(ip) {
        return (
          /^(\d{1,3}\.){3}\d{1,3}$/.test(ip) &&
          ip.split(".").every((n) => +n >= 0 && +n <= 255)
        );
      }

      function submitData() {
        const subnet = document.getElementById("subnet").value.trim();
        const macRaw = document.getElementById("macs").value;
        const ipRaw = document.getElementById("ips").value;

        const macs = macRaw
          .split(",")
          .map((x) => x.trim())
          .filter(isValidMAC);
        const ips = ipRaw
          .split(",")
          .map((x) => x.trim())
          .filter(isValidIP);

        if (macRaw && macs.length === 0) {
          document.getElementById("response").innerText =
            "Некорректные MAC-адреса!";
          return;
        }

        if (ipRaw && ips.length === 0) {
          document.getElementById("response").innerText =
            "Некорректные IP-адреса!";
          return;
        }

        fetch("/submit", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ subnet, known_mac: macs, known_ip: ips }),
        })
          .then((res) => res.json())
          .then((data) => {
            document.getElementById("response").innerText = data.message;
            document.getElementById("scanBtn").disabled = false;
          });
      }

      function toggleScan() {
        const btn = document.getElementById("scanBtn");
        if (!scanning) {
          fetch("/scan")
            .then((res) => res.json())
            .then((data) => {
              document.getElementById("response").innerText = data.status;
              btn.innerText = "Остановить сканирование";
              scanning = true;
            });
        } else {
          fetch("/stop_scan")
            .then((res) => res.json())
            .then((data) => {
              document.getElementById("response").innerText = data.status;
              btn.innerText = "Запустить сканирование";
              scanning = false;
            });
        }
      }
    </script>
  </body>
</html>
